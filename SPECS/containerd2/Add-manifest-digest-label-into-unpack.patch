From d0113ed6f76c7260573e9d0127d7520f7233361e Mon Sep 17 00:00:00 2001
From: Jiri Appl <jiria@microsoft.com>
Date: Sat, 4 Jan 2025 00:28:11 -0800
Subject: [PATCH] Add manifest digest label into Unpack

---
 client/image.go | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/client/image.go b/client/image.go
index 791db887e..d921501ed 100644
--- a/client/image.go
+++ b/client/image.go
@@ -334,7 +334,10 @@ func (i *image) Unpack(ctx context.Context, snapshotterName string, opts ...Unpa
 	}
 
 	for _, layer := range layers {
-		snOpts := append(config.SnapshotOpts, snapshots.WithLabels(map[string]string{snapshotters.TargetLayerDigestLabel: layer.Blob.Digest.String()}))
+		snOpts := append(config.SnapshotOpts, snapshots.WithLabels(map[string]string{
+			snapshotters.TargetLayerDigestLabel:    layer.Blob.Digest.String(),
+			snapshotters.TargetManifestDigestLabel: i.Target().Digest.String(),
+		}))
 		unpacked, err = rootfs.ApplyLayerWithOpts(ctx, layer, chain, sn, a, snOpts, config.ApplyOpts)
 		if err != nil {
 			return fmt.Errorf("apply layer error for %q: %w", i.Name(), err)
-- 
2.34.1

