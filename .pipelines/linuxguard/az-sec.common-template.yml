#################################################################################
#                               OneBranch Pipelines                             #
# This pipeline was created by EasyStart from a sample located at:              #
#   https://aka.ms/obpipelines/easystart/samples                                #
# Documentation:  https://aka.ms/obpipelines                                    #
# Yaml Schema:    https://aka.ms/obpipelines/yaml/schema                        #
# Retail Tasks:   https://aka.ms/obpipelines/tasks                              #
# Support:        https://aka.ms/onebranchsup                                   #
#################################################################################
parameters:
- name: isOfficialPipeline
  type: boolean
  default: false
- name: buildTargets # This list matches the variants we have templated in the .pipelines/vars/ directory. Additionally, buildTargets must follow the same naming conventions as stage id naming, this is because it is reused for uniquely identifying each buildTarget's stage. Valid names may only contain alphanumeric characters and '_'.
  type: object
  default:
    # - 'uki'
    - 'azl3'
- name: kernelBuildId
  type: number
  default: 767965

- name: repoSource
  type: string
  default: 'azlTemplates'

# resources:
#   repositories:
#     - repository: templates
#       type: git
#       name: OneBranch.Pipelines/GovernedTemplates
#       ref: refs/heads/main

# extends:
#   # https://aka.ms/obpipelines/templates
#   ${{ if eq(parameters.isOfficialPipeline, true) }}:
#     template: v2/OneBranch.Official.CrossPlat.yml@templates
#   ${{ else }}:
#     template: v2/OneBranch.NonOfficial.CrossPlat.yml@templates
#   parameters:
#     globalSdl: # https://aka.ms/obpipelines/sdl
#       tsa:
#         # SDL results of non-official builds aren't uploaded to TSA by default.
#         enabled: false
#       policheck:
#         # always break the build on policheck issues. You can disable it by setting to 'false'
#         break: true
#       suppression:
#         suppressionFile: $(Build.SourcesDirectory)\.gdn\global.gdnsuppress

stages:
- ${{ each target in parameters.buildTargets }}:
  - stage: build_${{ target }} # Note: 'target' must be passed into the 'build-and-validate' template as variable 'buildTarget'. The stage name, 'build_${{ target }}', is used by the 'build-and-validate' template for artifact publishing and downloading
    displayName: 'Build and Validate ${{ target }}'
    variables:
      - template: vars/vars-common.yml@azlTemplates # values shared amongst all build targets. Primarily for Azure infrastructure (SIGs, Managed Identities, Subscriptions, etc...) that backs the build/publish process
      - template: vars/vars-test.yml@azlTemplates
      - template: vars/vars-${{ target }}.yml@azlTemplates # This is where we import buildTarget specific values. Variables defined in this file will be accessible to all jobs within the stage below
      - name: BUILD_TARGET
        value: ${{ target }}
    jobs:
      - template: build-and-validate-template.yml@azlTemplates
        parameters:
          kernelBuildId: ${{ parameters.kernelBuildId }}
